name: Bootstrap - First-Time Azure Setup

on:
  workflow_dispatch:
    inputs:
      azure_username:
        description: "Azure login email (e.g. kbdazure@gmail.com)"
        required: true
      azure_password:
        description: "Azure login password"
        required: true
      github_pat:
        description: "GitHub PAT with Secrets read/write permission on this repo (classic: repo scope; fine-grained: Secrets: Read and write)"
        required: true
      db_password:
        description: "PostgreSQL password to set for the app"
        required: true
        default: "DownstreamDB@2024!"
      flask_secret:
        description: "Flask secret key"
        required: true
        default: "flask-downstream-secret-2024"

jobs:
  bootstrap:
    name: Bootstrap Azure + GitHub Secrets
    runs-on: ubuntu-latest
    permissions: {}

    steps:
      - name: Login to Azure (username/password)
        run: |
          # Mask credentials in logs
          echo "::add-mask::${{ inputs.azure_password }}"
          echo "::add-mask::${{ inputs.github_pat }}"
          az login -u "${{ inputs.azure_username }}" -p "${{ inputs.azure_password }}" --allow-no-subscriptions
          az account list --output table

      - name: Select Subscription
        run: |
          # Use first available subscription
          SUB_ID=$(az account list --query "[0].id" -o tsv)
          SUB_NAME=$(az account list --query "[0].name" -o tsv)
          TENANT_ID=$(az account list --query "[0].tenantId" -o tsv)
          az account set --subscription "$SUB_ID"
          echo "Using subscription: $SUB_NAME ($SUB_ID)"
          echo "SUB_ID=$SUB_ID"     >> "$GITHUB_ENV"
          echo "TENANT_ID=$TENANT_ID" >> "$GITHUB_ENV"

      - name: Bootstrap Terraform State Storage
        run: |
          RESOURCE_GROUP="tfstate-rg"
          LOCATION="eastus"
          SUFFIX=$(openssl rand -hex 4)
          STORAGE_ACCOUNT="tfstate${SUFFIX}"
          CONTAINER="tfstate"

          # Create resource group (ignore if exists)
          az group create --name "$RESOURCE_GROUP" --location "$LOCATION" || true

          # Create storage account
          az storage account create \
            --name "$STORAGE_ACCOUNT" \
            --resource-group "$RESOURCE_GROUP" \
            --location "$LOCATION" \
            --sku Standard_LRS \
            --min-tls-version TLS1_2 2>&1

          # Create blob container
          az storage container create \
            --name "$CONTAINER" \
            --account-name "$STORAGE_ACCOUNT" 2>&1

          echo "TF_STORAGE_ACCOUNT=$STORAGE_ACCOUNT" >> "$GITHUB_ENV"
          echo "Terraform state storage: $STORAGE_ACCOUNT"

      - name: Create Service Principal
        run: |
          SP_NAME="downstream-app-sp-$(date +%s)"
          # Create SP with Contributor role on the subscription
          SP_JSON=$(az ad sp create-for-rbac \
            --name "$SP_NAME" \
            --role Contributor \
            --scopes "/subscriptions/$SUB_ID" \
            --output json)

          CLIENT_ID=$(echo "$SP_JSON" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['appId'])")
          CLIENT_SECRET=$(echo "$SP_JSON" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['password'])")

          echo "ARM_CLIENT_ID=$CLIENT_ID"         >> "$GITHUB_ENV"
          echo "ARM_CLIENT_SECRET=$CLIENT_SECRET" >> "$GITHUB_ENV"
          echo "Service principal '$SP_NAME' created."

      - name: Generate SSH Key Pair
        run: |
          ssh-keygen -t ed25519 -f /tmp/downstream_deploy -N "" -C "downstream-app-deploy"
          SSH_PUB=$(cat /tmp/downstream_deploy.pub)
          SSH_PRIV=$(cat /tmp/downstream_deploy)
          echo "SSH_PUB=$SSH_PUB"   >> "$GITHUB_ENV"
          # Store private key (newlines encoded)
          printf '%s' "$SSH_PRIV" > /tmp/ssh_priv_encoded.txt
          echo "SSH_PRIV_FILE=/tmp/ssh_priv_encoded.txt" >> "$GITHUB_ENV"

      - name: Set GitHub Actions Secrets
        env:
          GH_TOKEN: ${{ inputs.github_pat }}
          REPO: ${{ github.repository }}
        run: |
          set_secret() {
            local name="$1"
            local value="$2"
            echo "Setting secret: $name"
            gh secret set "$name" --repo "$REPO" --body "$value"
          }

          set_secret "ARM_CLIENT_ID"       "$ARM_CLIENT_ID"
          set_secret "ARM_CLIENT_SECRET"   "$ARM_CLIENT_SECRET"
          set_secret "ARM_TENANT_ID"       "$TENANT_ID"
          set_secret "ARM_SUBSCRIPTION_ID" "$SUB_ID"
          set_secret "TF_STORAGE_ACCOUNT"  "$TF_STORAGE_ACCOUNT"
          set_secret "DB_PASSWORD"         "${{ inputs.db_password }}"
          set_secret "FLASK_SECRET"        "${{ inputs.flask_secret }}"
          set_secret "SSH_PUBLIC_KEY"      "$SSH_PUB"
          set_secret "SSH_PRIVATE_KEY"     "$(cat $SSH_PRIV_FILE)"
          set_secret "UPSTREAM_URL"        "http://localhost:5000"

          echo ""
          echo "========================================================"
          echo "  All GitHub secrets have been configured successfully!"
          echo "  Next: go to Actions > Deploy to Azure > Run workflow"
          echo "========================================================"
