name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  ARM_CLIENT_ID:       ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET:   ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_TENANT_ID:       ${{ secrets.ARM_TENANT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

jobs:
  terraform:
    name: Terraform - Provision Infrastructure
    runs-on: ubuntu-latest
    outputs:
      app_public_ip: ${{ steps.tf_output.outputs.app_public_ip }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.x"
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config="storage_account_name=${{ secrets.TF_STORAGE_ACCOUNT }}"

      - name: Terraform Plan
        working-directory: ./terraform
        env:
          TF_VAR_db_password:    ${{ secrets.DB_PASSWORD }}
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
          TF_VAR_flask_secret:   ${{ secrets.FLASK_SECRET }}
          TF_VAR_admin_username: "kalyan2212"
          TF_VAR_upstream_url:   ${{ secrets.UPSTREAM_URL }}
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        working-directory: ./terraform
        env:
          TF_VAR_db_password:    ${{ secrets.DB_PASSWORD }}
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
          TF_VAR_flask_secret:   ${{ secrets.FLASK_SECRET }}
          TF_VAR_admin_username: "kalyan2212"
          TF_VAR_upstream_url:   ${{ secrets.UPSTREAM_URL }}
        run: terraform apply tfplan

      - name: Capture Terraform Outputs
        id: tf_output
        working-directory: ./terraform
        run: |
          APP_IP=$(terraform output -raw app_public_ip)
          echo "app_public_ip=$APP_IP" >> "$GITHUB_OUTPUT"
          echo "===================================="
          echo "  App URL : http://$APP_IP"
          echo "  SSH     : ssh kalyan2212@$APP_IP"
          echo "===================================="

  deploy:
    name: Deploy - SSH Code Push
    needs: terraform
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to App VM via SSH
        env:
          APP_IP:          ${{ needs.terraform.outputs.app_public_ip }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          SSH_OPTS="-i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o BatchMode=yes"

          DEPLOY_SCRIPT='
            set -e
            cd /opt/downstream-app
            git pull origin main
            ./venv/bin/pip install -r requirements.txt --quiet
            sudo systemctl restart downstream
            echo "Restart successful on $(hostname)"
          '

          echo "=== Deploying to App VM at $APP_IP ==="
          ssh $SSH_OPTS kalyan2212@"$APP_IP" "$DEPLOY_SCRIPT" \
            || echo "[WARN] SSH failed - VM may still be initializing (cloud-init running)"

          echo "Application URL: http://$APP_IP"

  health-check:
    name: Health Check
    needs: [terraform, deploy]
    runs-on: ubuntu-latest

    steps:
      - name: Wait for app to be ready
        env:
          APP_IP: ${{ needs.terraform.outputs.app_public_ip }}
        run: |
          echo "Waiting for http://$APP_IP/health to respond..."
          for i in $(seq 1 24); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "http://$APP_IP/health" || true)
            echo "  attempt $i/24 - HTTP $STATUS"
            if [ "$STATUS" = "200" ]; then
              echo "Health check PASSED"
              curl -s "http://$APP_IP/health" | python3 -m json.tool
              echo "App is live at: http://$APP_IP"
              exit 0
            fi
            sleep 15
          done
          echo "Health check FAILED after 6 minutes"
          exit 1

