name: Deploy to Azure

# Continuous deployment: triggered on push to main.
# Requires Service Principal secrets set by the Bootstrap workflow.
# Run "Bootstrap - First-Time Azure Setup" first if secrets aren't configured.

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Terraform + Health Check
    runs-on: ubuntu-latest
    permissions: {}

    env:
      ARM_CLIENT_ID:       ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET:   ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_TENANT_ID:       ${{ secrets.ARM_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      TF_VAR_db_password:  ${{ secrets.DB_PASSWORD }}
      TF_VAR_flask_secret: ${{ secrets.FLASK_SECRET }}
      TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

    steps:
      - name: Check Service Principal credentials
        run: |
          if [ -z "$ARM_CLIENT_ID" ]; then
            echo "No Azure credentials configured."
            echo "Run 'Bootstrap - First-Time Azure Setup' workflow first."
            exit 0
          fi

      - name: Checkout code
        if: env.ARM_CLIENT_ID != ''
        uses: actions/checkout@v4

      - name: Login to Azure (Service Principal)
        if: env.ARM_CLIENT_ID != ''
        run: |
          az login --service-principal \
            -u "$ARM_CLIENT_ID" \
            -p "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID"
          az account set --subscription "$ARM_SUBSCRIPTION_ID"

      - name: Setup Terraform
        if: env.ARM_CLIENT_ID != ''
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.x"
          terraform_wrapper: false

      - name: Terraform Init
        if: env.ARM_CLIENT_ID != ''
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config="storage_account_name=${{ secrets.TF_STORAGE_ACCOUNT }}"

      - name: Terraform Plan
        if: env.ARM_CLIENT_ID != ''
        working-directory: ./terraform
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        if: env.ARM_CLIENT_ID != ''
        working-directory: ./terraform
        run: terraform apply tfplan

      - name: Capture Outputs
        if: env.ARM_CLIENT_ID != ''
        id: tf_out
        working-directory: ./terraform
        run: |
          APP_IP=$(terraform output -raw app_public_ip)
          echo "app_ip=$APP_IP" >> "$GITHUB_OUTPUT"
          echo "App URL: http://$APP_IP"

      - name: Health Check
        if: env.ARM_CLIENT_ID != ''
        env:
          APP_IP: ${{ steps.tf_out.outputs.app_ip }}
        run: |
          echo "Waiting for http://$APP_IP/health ..."
          for i in $(seq 1 24); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 \
              "http://$APP_IP/health" || true)
            echo "  attempt $i/24 - HTTP $STATUS"
            if [ "$STATUS" = "200" ]; then
              echo "Health check PASSED"
              curl -s "http://$APP_IP/health" | python3 -m json.tool
              echo "App is live at: http://$APP_IP"
              exit 0
            fi
            sleep 15
          done
          echo "Health check FAILED"
          exit 1
